<!DOCTYPE html>
<html>
  <head>
    <title>Simulation</title>

    <script src="/static/lib/jquery-min.js" type="text/javascript"> </script>
    <script src="/static/lib/underscore-min.js" type="text/javascript"> </script>
    <script src="/static/lib/backbone-min.js" type="text/javascript"> </script>
    <script src="/static/lib/d3.v3.min.js" type="text/javascript"> </script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/static/css/bootstrap.min.css.4.3.1.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/style.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/jspsych.css" type="text/css" />
  </head>

  <body>

  <style>
    table {
        /* #font-size: 0.8em; /* Reduce font size */
        padding: 0; /* Remove padding */
        margin: 0; /* Remove margin */
        line-height: 1; /* Reduce line height */
    }
</style>

<div class="container-fluid" style="padding-left: 5%; padding-right: 5%">
  <div id="container-instructions" class="text-center">
    <!-- non button section, id'd by non-buttons, should be entirely replaced by
    survey when we get to end of all of training -->
    <div id="non-buttons">
          <div id="center-container">
              <div id="loading-container">
                  <div class="spinner"></div>
                  <div id="loading-text">Loading the next instruction...</div>
              </div>
          </div>
    <div id="preamble" class="pre_info">
        <h1 id="header">Participant gameplay</h1> <hr/>
        <div id = "info_main"></div>
    </div>
    <!--<h2 id="debug"></h2><br><br><br>-->
    <div class="row justify-content-around">
        <canvas id="game" width="850" height="500"></canvas>
        <div id="container">
            <div id="table_controlinfo"></div>
            <!-- only for wtcl and wt -->
            <!--<div id="reward_weight_table"><br>
            <table width="500">
                <tr><th>Actions</th><th>Energy change</th></tr>
                <tr><td>Moving out of a yellow square</td><td>- 3%</td></tr>
                <tr><td>Moving through the green hexagon</td><td>+ 3.5%</td></tr>
                <tr><td>Any action that you take</td><td>- 1%</td></tr>
            </table>
            <br></div>-->
        </div>
    </div>

<div id="feedback"></div>
    <div id="survey"></div>
    <hr>
    <br>
    </div>

    <div id="instructions" class="instructionsnav">
        <div class="row justify-content-between">
          <div class="col-xs-3">
            <button type="button" id="prev" onclick="prev()" value="previous" class="btn btn-primary btn-lg continue"> Previous <span class="glyphicon glyphicon-arrow-left"></span>
            </button>
          </div>
          <div class="col-xs-3">
                <button type="button" id="next" disabled
            onclick="next()"
            value="next" class="btn btn-primary btn-lg continue">
            Next <span class="glyphicon glyphicon-arrow-right"></span>
            </button>
          </div>
        </div>
    </div>
    <br>
    <br>
    </div>
    </div>

  <script>
      // hide the game instructions and preamble and show a loading screen while waiting to receive the necessary game data
      document.getElementById('instructions').style.display = 'none';
      document.getElementById('preamble').style.display = 'none';

      var roomIdentifier = localStorage.getItem("username")

      if (roomIdentifier == null) {
          // the username will available in localStorage after the first page between augmented_taxi2.html, colored_tiles.html, skateboard2.html
          // for the first page, simply make up a placeholder which statistically won't conflict (and the first page of each domain should load instantaneously anyways)
          roomIdentifier = Math.floor(Math.random() * 100000000000000);
      }

      var socket = io();

    const loadingText = document.getElementById('loading-text');
    socket.on('message', function(data) {
        if (data === "Progress updates complete") {
            console.log('Progress updates complete');
        } else {
            var progress = parseInt(data);
            if (isNaN(progress)) {
                progress = 0
            }
            loadingText.innerHTML = `Loading the next instruction... (${progress}% completed)`
        }
    });

      function populateData() {
            let data = {};
            data["domain"] = localStorage.getItem("domain");
            data["interaction type"] = localStorage.getItem("interaction type");
            data["survey"] = localStorage.getItem("survey")
            data["iteration"] = Number(localStorage.getItem("iteration"));
            data["subiteration"] = Number(localStorage.getItem("subiteration"));
            data["user input"] = JSON.parse(localStorage.getItem("user input"));
            data["movement"] = localStorage.getItem("movement");
            data["attn1"] = localStorage.getItem("attn1");
            data["attn2"] = localStorage.getItem("attn2");
            data["attn3"] = localStorage.getItem("attn3");
            data["use1"] = localStorage.getItem("use1");
            data["use2"] = localStorage.getItem("use2");
            data["use3"] = localStorage.getItem("use3");
            data["understanding"] = localStorage.getItem("understanding");
          data["engagement short answer"] = localStorage.getItem("engagement short answer");
          data["improvement short answer"] = localStorage.getItem("improvement short answer");
          data["already completed"] = localStorage.getItem("already completed");

          let reward_ft_wt_1_field = document.getElementById("reward_ft_wt_1")
          let reward_ft_wt_2_field = document.getElementById("reward_ft_wt_2")
          if ((reward_ft_wt_1_field != null) && (reward_ft_wt_2_field != null)) {
                data["reward_ft_weights"] = [reward_ft_wt_1_field.value, reward_ft_wt_2_field.value]
            } else {
                data["reward_ft_weights"] = []
          }
          return data
      }

      socket.on("connect", function () {
          data = populateData()
          socket.emit("settings", data);
        });
        socket.on("settings configured", function (data) {
            localStorage.setItem("username", data["username"]);
            localStorage.setItem("movement", "false");
            localStorage.setItem("user input", "{}");
            // localStorage.setItem("game completed", "false");
            // localStorage.setItem("survey completed", "false");
            localStorage.setItem("survey", "-1");
            window.mdp_parameters = data["params"];
            window.interaction_type = data["interaction type"]; // types possible: demo, diagnostic test, diagnostic feedback, remedial demo, remedial test, remedial feedback, survey, final test
            localStorage.setItem("already completed", data["already completed"]);
            localStorage.setItem("domain", data["domain"]);
            localStorage.setItem("interaction type", data["interaction type"]);
            localStorage.setItem("iteration", data["iteration"]);
            localStorage.setItem("subiteration", data["subiteration"]);
            localStorage.setItem("demo total", data["demo total"]);
            if (data["go prev"] === "false") {
                $("#prev").replaceWith(`<button type="button" id="prev" disabled onclick="prev()" value="previous" class="btn btn-primary btn-lg continue"> Previous <span class="glyphicon glyphicon-arrow-left"></span>
            </button>`);
            }
            if (data["already completed"] === "true") {
                $("#next").replaceWith(`<button type="button" id="next"
                    onclick="next()"
                    value="next" class="btn btn-primary btn-lg continue">
                    Next <span class="glyphicon glyphicon-arrow-right"></span>
                    </button>` );
            }
            $("#debug").html(data["debug string"]);
            if (data["last test"]) {
                localStorage.setItem("last test", "true");
            }
            // hide the loading screen and show the game content
            document.getElementById('center-container').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('preamble').style.display = 'block';
            // don't show the previous button for final tests
            if (window.interaction_type == 'final test') {
                document.getElementById('prev').style.display = 'none';
            }
            console.log(window.interaction_type);
            //console.log(window.mdp_parameters);
            change_text(window.interaction_type);
            run_page(window.mdp_parameters);
        });

        // Shuffle function
        function shuffle(array) {
            var currentIndex = array.length, temporaryValue, randomIndex;
            while (0 !== currentIndex) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }
            return array;
        }

        // Assign html for interaction type
        function change_text(interaction_type){
            console.log("changing text")
            if (interaction_type === "survey") {
                var questions = [
                    {
                        question: "I was fully engaged with learning the game strategy.",
                        name: "attn1"
                    },
                    {
                        question: "The time I spent learning the game strategy passed by quickly.",
                        name: "attn2"
                    },
                    {
                        question: "I was absorbed in this experience.",
                        name: "attn3"
                    },
                    {
                        question: "I felt frustrated while learning the game strategy.",
                        name: "use1"
                    },
                    {
                        question: "I found learning the game strategy confusing.",
                        name: "use2"
                    },
                    {
                        question: "Learning the game strategy was taxing.",
                        name: "use3"
                    },
                ];
                // Shuffle the questions
                questions = shuffle(questions);

                // Generate the HTML
                var html = `<br></br>
            <h2>The following statements ask you to <u>reflect on your experience of engaging with Chip</u> to learn the game strategy. For each statement, please use the following scale to indicate what is most true for you.</h2>
            <br></br>`;

                for (var i = 0; i < questions.length; i++) {
                    html += `<h3>${questions[i].question}</h3>
                <div class="likert">
                <label><input name="${questions[i].name}" type="radio" value="1"/><span>Strongly Disagree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="2"/><span>Disagree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="3"/><span>Neither Agree nor Disagree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="4"/><span>Agree</span></label>
                <label><input name="${questions[i].name}" type="radio" value="5"/><span>Strongly Agree</span></label>
                </div>
                <br></br>`;
                }

                html += `<h3>Finally, do you feel that you now understand the game strategy?</h3>
            <div class="likert">
                <label><input name="understanding" type="radio" value="1"/><span>Strongly Disagree</span></label>
                <label><input name="understanding" type="radio" value="2"/><span>Disagree</span></label>
                <label><input name="understanding" type="radio" value="3"/><span>Neither Agree nor Disagree</span></label>
                <label><input name="understanding" type="radio" value="4"/><span>Agree</span></label>
                <label><input name="understanding" type="radio" value="5"/><span>Strongly Agree</span></label>
                </div>
                <br></br>`;

                html += `<h3>Please feel free to explain any of your selections above or any comments or thoughts you'd like to share!</h3>
            <textarea id="engagement short answer" rows="4" cols="50"></textarea>`;

                $("#non-buttons").html(html);
            } else if ((interaction_type == "diagnostic test") || (interaction_type == "remedial test") || (interaction_type == "final test")) {
                if (localStorage.getItem("already completed") == 'true') {
                     $("#table_controlinfo").replaceWith(`<div><br><br>
        <table width="500">
            <tr><th>Key</th><th>Action</th></tr>
            <tr><td>space bar</td><td>next movement</td></tr>
            <tr><td>r</td><td>reset simulation</td></tr>
        </table>
        <br></div>`);
                }
                else {
                    $("#table_controlinfo").replaceWith(`<div><br>
        <table width="500">
            <tr><th>Key</th><th>Effect</th></tr>
            <tr><td>up/down/left/right arrow keys</td><td>corresponding movement</td></tr>
            <tr><td>g</td><td>grab</td></tr>
            <tr><td>d</td><td>drop</td></tr>
            <tr><td>r</td><td>reset simulation</td></tr>
        </table>
        <br></div>`);
                }
                if (interaction_type == "final test") {
                    $("#header").replaceWith('<h1>Strategy assessment (' + (Number(localStorage.getItem("iteration")) + 1).toString() + '/6)</h1>');
                    // cl, pl, open, wtcl
                    $("#info_main").replaceWith('<h3>Chip has finished teaching the strategy -- let\'s see how much you learned!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br>(We\'ll reveal which and how many of the six tests you answered correctly after the final one.)');
                    // wt
                    //$("#info_main").replaceWith('<h3>Chip has finished teaching the strategy -- let\'s see how much you learned!<br>Please demonstrate how you would complete this <b>game\'s task (dropping the pink circle at the grey square) </b> <br> ' +
                    //'while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br>(We\'ll reveal which and how many of the six tests you answered correctly after the final one.)');
                } else if (interaction_type == "diagnostic test") {
                    $("#header").replaceWith('<h1>Check-in test</h1>');
                    if (localStorage.getItem("already completed") == 'true') {
                        $("#info_main").replaceWith('<h3>Let\'s see if you understood the previous demonstration(s)!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br><br><p><b>(Edit: You navigated back to this interaction so you may step through the answer using your space bar.)</b></p>');
                    }
                    else {
                        $("#info_main").replaceWith('<h3>Let\'s see if you understood the previous demonstration(s)!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.');
                    }
                } else if (interaction_type == "remedial test") {
                    $("#header").replaceWith('<h1>Additional test</h1>');
                    if (localStorage.getItem("already completed") == 'true') {
                        $("#info_main").replaceWith('<h3>Let\'s see if you can correctly apply the strategy this time!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.<br><br><p><b>(Edit: You navigated back to this interaction so you may step through the answer using your space bar.)</b></p>');
                    }
                    else {
                        $("#info_main").replaceWith('<h3>Let\'s see if you can correctly apply the strategy this time!<br>Please demonstrate how you would complete this game\'s task while minimizing Chips energy loss.</h3>You <b>may reset</b> at any time <b>before the game ends</b> if think you have made a mistake.');
                    }
                }
            } else {
                $("#table_controlinfo").replaceWith(`<div><br><br>
        <table width="500">
            <tr><th>Key</th><th>Action</th></tr>
            <tr><td>space bar</td><td>next movement</td></tr>
            <tr><td>r</td><td>reset simulation</td></tr>
        </table>
        <br></div>`);
                if (interaction_type == "diagnostic feedback" || interaction_type == "remedial feedback") {
                    $("#header").replaceWith('<h1>Corrective feedback</h1>');
                    $("#info_main").replaceWith('<h3>Step through how your answer (replayed by <img src=\'static/img/agent_light.png\' width=\"30\" height=auto/>) differs from Chip\'s (replayed by <img src=\'static/img/agent_dark.png\' width=\"30\" height=auto/>) using your space bar.<br>Feel free to run through it as many times as you wish by resetting, and at least once to continue!</h3>');
                }
                else if (interaction_type == "remedial demo") {
                    $("#header").replaceWith('<h1>Additional demonstration of best strategy</h1>');
                    $("#info_main").replaceWith('<h3>Given your previously incorrect test response, here\'s a demonstration that might help address any misunderstandings.<br>Step through the demonstration using your space bar. Feel free to run through it as many times as you wish by resetting, and at least once to continue!</h3>');
                }
                else {
                    $("#header").replaceWith('<h1>Demonstration of best strategy (' + (Number(localStorage.getItem("iteration")) + 1).toString() + '/' + localStorage.getItem("demo total") + ')</h1>');
                    $("#info_main").replaceWith('<h3>Step through the demonstration <u>using your space bar</u>.<br>Feel free to run through it as many times as you wish by resetting, and at least once to continue!</h3>');
                }
            }
        }

        // socket.on("", function (data) {
        //     if (data["passed"]) {
        //         $("button").replaceWith(`<button type="button" id="next"
        //             onclick="make_sandbox()"
        //             value="next" class="btn btn-primary btn-lg continue">
        //             Next <span class="glyphicon glyphicon-arrow-right"></span>
        //             </button>` );
        //     }
        // }
        // );

        function prev() {
            console.log("I am going prev");
            localStorage.setItem("movement", "prev");
            window.location.href="/at";
        }


        function next() {
            localStorage.setItem("movement", "next");
            //localStorage.setItem("survey completed", "false");
            if (localStorage.getItem("last test") === "true") {
                localStorage.setItem("last test", "false");

                // save the information of the final test
                page_data = populateData()
                socket.emit("next domain", page_data);

                socket.on("next domain is", function(data) {
                    console.log("I have received next domain");
                    let url = "";
                    if (data["domain"].length === 2){
                        url = "/".concat(data["domain"], "_intro");
                    }
                    else {
                        url = "final_survey";
                    }
                    window.location.href=url;
                });
            }
            else {
                window.location.href='/at';
            //     let data = {};
            // // data["domain"] = localStorage.getItem("domain");
            // // data["interaction type"] = localStorage.getItem("interaction type");
            // // data["iteration"] = Number(localStorage.getItem("iteration"));
            // // data["subiteration"] = Number(localStorage.getItem("subiteration"));
            // data["user input"] = JSON.parse(localStorage.getItem("user input"));
            // socket.emit("settings", data);
            }

        }
        addEventListener("beforeunload", (event) => {
            if (localStorage.getItem("movement") === "false") {
                event.preventDefault();
                event.returnValue = "Are you sure you want to leave? The task is incomplete.";
            }

            if (window.interaction_type === "survey") {
                localStorage.setItem("engagement short answer", document.getElementById("engagement short answer").value);
            }

            else {
                let engagement_sa = document.getElementById("engagement short answer")
                let improvement_sa = document.getElementById("improvement short answer")

                if (engagement_sa) localStorage.setItem("engagement short answer", engagement_sa.value.trim());
                else localStorage.setItem("engagement short answer", '');
                if (improvement_sa) localStorage.setItem("improvement short answer", improvement_sa.value.trim());
                else localStorage.setItem("improvement short answer", '');

                let simulation_rt = 0;
                if (localStorage.getItem("user input") === "{}") {
                    if (window.moves.length > 0) {
                        simulation_rt = performance.now() - window.start_time;
                    }
                    final_data = JSON.stringify({
                        'moves': window.moves,
                        'opt_response': false,
                        'agent_history_nonoffset': window.agent_history_nonoffset,
                        'mdp_parameters': window.mdp_parameters,
                        'simulation_rt': simulation_rt,
                    });
                    localStorage.setItem("user input", final_data);
                }
            }

        });

         addEventListener("input", (event) => {
            if ((window.interaction_type == "final test") && (localStorage.getItem("last test") == "true")) {
                var reward_ft_wt_1 = document.getElementById('reward_ft_wt_1')
                var reward_ft_wt_2 = document.getElementById('reward_ft_wt_2')
                if (reward_ft_wt_1.value !== "" && reward_ft_wt_2.value !== "") {
                    $("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>`);
                }
                else {
                    // disable button again if one of the fields is deleted
                    $("#next").replaceWith(`<button type="button" id="next" disabled
                            onclick="next()"
                            value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                    </button>`);
                }
            }
            else if (window.interaction_type !== "survey") {
                localStorage.setItem("survey completed", "true");
                // checked based on input name
                let radioValue = $("input[name='info']:checked").val();
                if(radioValue) {
                    localStorage.setItem("survey", radioValue);
                    $("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>`);
                }
            }
            else {
                let attn1 = $("input[name='attn1']:checked").val();
                if(attn1) {
                    localStorage.setItem("attn1", attn1);
                }
                let attn2 = $("input[name='attn2']:checked").val();
                if(attn2) {
                    localStorage.setItem("attn2", attn2);
                }
                let attn3 = $("input[name='attn3']:checked").val();
                if(attn3) {
                    localStorage.setItem("attn3", attn3);
                }
                let use1 = $("input[name='use1']:checked").val();
                if(use1) {
                    localStorage.setItem("use1", use1);
                }
                let use2 = $("input[name='use2']:checked").val();
                if(use2) {
                    localStorage.setItem("use2", use2);
                }
                let use3 = $("input[name='use3']:checked").val();
                if(use3) {
                    localStorage.setItem("use3", use3);
                }
                let understanding = $("input[name='understanding']:checked").val();
                if(use3) {
                    localStorage.setItem("understanding", understanding);
                }

                if (attn1 && attn2 && attn3 && use1 && use2 && use3 && understanding) {
                    $("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>` );
                }
            }
        });



  function run_page(mdp_parameters) {
    var canvas = document.getElementById("game");
    var context = canvas.getContext("2d");

    // variables for parent window
    var final_data = [];
    var data_sent = false;

    window.start_time = 0;
    window.moves = [];
    window.agent_history = [];            // for drawing a history of the agent's path
    window.agent_history_nonoffset = [];  // for keeping track of the agent's location in gridworld integers

    var offset_x = 1.5;
    var offset_y = 1;
    disableScroll();

    // var mdp_parameters = window.parent.mdp_parameters;


    // var watched_vid_arr = window.parent.watched_vid_arr;
    // var current_page = window.parent.current_page;


    var text_color = "#394d7e";

    var map_layout = {};


    var spaceship =
    {
        color: "#628dbe",
        color_light: "#7cb8fc",//"#b90f0a",
        width: 65,
        height: 130,
        grid_loc:
        {
            x: 0,
            y: 0,
            human_x: 0,
            human_y: 0
        },
        taxi_set: false,
    }

    var passenger =
    {
        color: "#B395C4",
        color_light: "#C8BBF5",
        width: 350,
        height: 350,
        grid_loc:
        {
            x: 0,
            y: 0,
            human_x: 0,
            human_y: 0
        },
        picked: false,
        picked_human: false,
        dropped: false,
        dropped_human: false
    }

    var hotswap_station =
    {
        color: "#58895F",
        color_light: "#81cc8b",
        width: 350,
        height: 350,
        grid_loc:
        {
            x: 0,
            y: 0,
            human_x: 0,
            human_y:0
        },
        visited: false,
        visited_human: false,
    }

    var goal =
    {
        grid_loc:
        {
            x: 0,
            y: 0
        }
    }

    function build_grid(){
        //create a grid
        temp = [];
        for (i = 0; i < mdp_parameters.height; i++) {
            temp.push([0]);
        }
        for (j = 0; j < mdp_parameters.height-1; j++) {
            for (k = 0; k < mdp_parameters.width-1; k++) {
                temp[j].push(0)
            }
        }
        return temp;
    }

    function set_grids()
      {
          //set location of taxi
          spaceship.grid_loc.x =  (mdp_parameters.agent.x-1) + offset_x;
          spaceship.grid_loc.y =  (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
          spaceship.grid_loc.human_x =  (mdp_parameters.agent.x-1) + offset_x + agent_human_spacer;
          spaceship.grid_loc.human_y =  (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
          window.agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y])
          window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
          spaceship.taxi_set = true;
        //set location of passenger
        if (mdp_parameters.agent.has_passenger == 1){
            passenger.picked = true;
            passenger.picked_human = true;
            passenger.grid_loc.x = (mdp_parameters.agent.x-1) + offset_x;
            passenger.grid_loc.y = (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
            passenger.grid_loc.human_x = (mdp_parameters.agent.x-1) + offset_x + agent_human_spacer;
            passenger.grid_loc.human_y = (mdp_parameters.height - mdp_parameters.agent.y) + offset_y;
        }
        else{
            passenger.grid_loc.x = (mdp_parameters.passengers[0].x-1) + offset_x;
            passenger.grid_loc.y = (mdp_parameters.height - mdp_parameters.passengers[0].y) + offset_y;
            passenger.grid_loc.human_x = (mdp_parameters.passengers[0].x-1) + offset_x + agent_human_spacer;
            passenger.grid_loc.human_y = (mdp_parameters.height - mdp_parameters.passengers[0].y) + offset_y;
        }
        //set destination
        destination_grid = build_grid();
        goal.grid_loc.x = mdp_parameters.passengers[0].dest_x;
        goal.grid_loc.y = mdp_parameters.height - mdp_parameters.passengers[0].dest_y + 1;
        destination_grid[mdp_parameters.height - mdp_parameters.passengers[0].dest_y][mdp_parameters.passengers[0].dest_x-1] = 1;
        map_layout.destination = destination_grid;

        //set walls
        color_locs = build_grid();
        for (i = 0; i < mdp_parameters.walls.length; i++) {
            color_locs[mdp_parameters.height - mdp_parameters.walls[i].y][mdp_parameters.walls[i].x-1] = 1;
        }
        for (j = 0; j < mdp_parameters.tolls.length; j++) {
            color_locs[mdp_parameters.height - mdp_parameters.tolls[j].y][mdp_parameters.tolls[j].x-1] = 2;
        }
        map_layout.color_blocks = color_locs;

        if (mdp_parameters.hotswap_station.length > 0) {
            hotswap_station.grid_loc.x =  (mdp_parameters.hotswap_station[0].x-1) + offset_x;
            hotswap_station.grid_loc.y =  (mdp_parameters.height - mdp_parameters.hotswap_station[0].y + offset_y);
            hotswap_station.grid_loc.human_x =  (mdp_parameters.hotswap_station[0].x-1) + offset_x + agent_human_spacer;
            hotswap_station.grid_loc.human_y =  (mdp_parameters.height - mdp_parameters.hotswap_station[0].y + offset_y);
        } else {
            hotswap_station.visited = true;
            hotswap_station.visited_human = true;
        }

      }

    //http://www.scienceprimer.com/drawing-regular-polygons-javascript-canvas
      function drawHexagon(Xcenter, Ycenter, color) {
            var numberOfSides = 6, size = 10;

            context.beginPath();
            context.moveTo (Xcenter +  size * Math.cos(0), Ycenter +  size *  Math.sin(0));

            for (var i = 1; i <= numberOfSides;i += 1) {
              context.lineTo (Xcenter + size * Math.cos(i * 2 * Math.PI / numberOfSides), Ycenter + size * Math.sin(i * 2 * Math.PI / numberOfSides));
            }
            context.fillStyle = color;
            context.fill();
            context.closePath()
      }


      function drawTaxi(x,y,color)
      {
        if (spaceship.taxi_set == false){
            taxiSet();
        }
        context.save();
        context.beginPath();
        context.translate(100*(x) + 50 + translate_draw, 100*(y) + 150);
            context.lineTo(-spaceship.width * 0.5 , -spaceship.height * 0.5);
            context.lineTo(0, -spaceship.height);
            context.lineTo(-spaceship.width * -0.5, -spaceship.height * 0.5);
        if (color == "light"){
            context.fillStyle = spaceship.color_light;
        }
        else {
            context.fillStyle = spaceship.color;
        }
        context.fill();
        context.closePath();
        context.restore();
      }

      function drawPassenger(x,y,color)
      {
        context.save();
        context.beginPath();
        var i = 0;
        var j = 0;
        if (color == "light"){
            context.fillStyle = passenger.color_light;
            condition = !passenger.picked_human;
            if (!passenger.picked_human){
                context.arc(x*100 + 25 + translate_draw, y*100 + 45, 9, 0, 2 * Math.PI);
                context.fill();
                context.closePath();
            }
            else{
                context.arc(x*100 + 49 + translate_draw, y*100 + 22, 9, 0, 2 * Math.PI);
                context.fill();
                context.closePath();
            }
        }
        else {
            context.fillStyle = passenger.color;
            condition = !passenger.picked;
            if (!passenger.picked){
            context.arc(x*100 + 25 + translate_draw, y*100 + 45, 9, 0, 2 * Math.PI);
            context.fill();
            context.closePath();

            }
            else{
                context.arc(x*100 + 49 + translate_draw, y*100 + 22, 9, 0, 2 * Math.PI);
                context.fill();
                context.closePath();
            }
        }
        context.restore();
      }

    function drawAgentHistory()
    {
        context.save();
        for (j = 0; j < agent_history.length; j++) {
            context.beginPath();
            if (j == 0) {
                context.rect(agent_history[j][0]*100 + 37, agent_history[j][1]*100 + 48, 25, 4);
                context.fillStyle = '#677387';
            }
            context.arc(agent_history[j][0]*100 + 50, agent_history[j][1]*100 + 50, 6, 0, 2 * Math.PI);
            context.fillStyle = '#677387';
            context.fill();
            context.closePath();
        }
        context.restore();
    }

    function drawHotswapStation(x,y,version){
        context.save();
        if (version == "agent"){
            if (!hotswap_station.visited){
            drawHexagon(x * 100 + 50 + translate_draw, y * 100 + 50, hotswap_station.color)
        }}
        else{
            if (!hotswap_station.visited_human){
            drawHexagon(x * 100 + 50 + translate_draw, y * 100 + 50, hotswap_station.color_light)
        }
        }
        context.restore();
      }

    function drawDestination(){
        context.save();
        context.beginPath();
        var i = 0;
        var j = 0;

        for (i = 0; i < mdp_parameters.height; i++) {
            for (j = 0; j < mdp_parameters.width; j++) {
                if (map_layout.destination[i][j] == 1){
                    context.beginPath();
                    context.rect(100*j + 15+offset_x*100, 100*i + 15 + offset_y*100, 19,15);
                    context.fillStyle = "#8a8a8a";
                    context.fill();
                    context.closePath();
                }
            }
        }
        context.restore();
    }


    function drawMap(){
        context.save();
            var i;
            var j;
            for (i = 0; i < mdp_parameters.height; i++) {
                for (j = 0; j < mdp_parameters.width; j++) {
                    if (map_layout.color_blocks[i][j] == 2){
                        context.beginPath();
                        context.rect(4 + 100*j+offset_x*100, 4+100*i + offset_y*100, 92, 92);
                        context.fillStyle = "#E0E644";
                        context.fill();
                        context.closePath();
                    }
                    if (map_layout.color_blocks[i][j] == 1){
                        context.beginPath();
                        context.rect(4 + 100*j+offset_x*100, 4+100*i + offset_y*100, 92, 92);
                        context.fillStyle = "#2E3131";
                        context.fill();
                        context.closePath();
                    }
                }
            }
        context.restore();
    }

    function start_screen() {
        if (!map_layout.set){
            set_grids();
            map_layout.set = true;
        }
        // Clear entire screen
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.beginPath();
        context.fillStyle = "black";
        context.fill();
        context.closePath();


        //draw grid
        // vertical
        for (i = 0; i <= mdp_parameters.height; i++) {
            context.beginPath();
            context.moveTo(0+offset_x*100, 100*i-1+offset_y*100);
            context.lineTo(0+offset_x*100, 100*i+1+offset_y*100);
            context.lineTo(mdp_parameters.width*100+offset_x*100, 100*i+1+offset_y*100);
            context.lineTo(mdp_parameters.width*100+offset_x*100, 100*i-1+offset_y*100);
            context.fillStyle = "black";
            context.fill();
            context.closePath();
        }

        // horizontal
        for (i = 0; i <= mdp_parameters.width; i++) {
            context.beginPath();
            context.moveTo(100*i-1+offset_x*100, 0+offset_y*100);
            context.lineTo(100*i+1+offset_x*100, 0+offset_y*100);
            context.lineTo(100*i+1+offset_x*100, mdp_parameters.height*100+offset_y*100);
            context.lineTo(100*i-1+offset_x*100, mdp_parameters.height*100+offset_y*100);
            context.fillStyle = "black";
            context.fill();
            context.closePath();
        }

          // indicate to the participant that it's their turn play
          if ((window.interaction_type.includes("test")) && (localStorage.getItem("already completed") == 'false')) {
            context.font = "25px Arial";
            context.fillStyle = text_color;
            context.textAlign = "center";
            context.fillText("Your turn to play!", offset_x * 100 + 200, 80);

            // Draw blue border around the grid
            context.beginPath();
            context.rect(offset_x*100 - 3, offset_y*100 - 3, mdp_parameters.width*100 + 6, mdp_parameters.height*100 + 6);
            context.strokeStyle = "blue";
            context.lineWidth = 2;
            context.stroke();
        }

        context.beginPath();
        // Begin drawing
        drawMap();
        //Single destination irrespective of version
        drawDestination();
        if (mdp_parameters.tag  == -2){
            drawTaxi(spaceship.grid_loc.human_x,spaceship.grid_loc.human_y,"light");
            drawPassenger(passenger.grid_loc.human_x,passenger.grid_loc.human_y,"light");
            drawHotswapStation(hotswap_station.grid_loc.human_x,hotswap_station.grid_loc.human_y,"human");
        }
        drawHotswapStation(hotswap_station.grid_loc.x,hotswap_station.grid_loc.y,"agent");
        if (mdp_parameters.tag  == -1){
            //Not needed unless single agents
            drawAgentHistory();
        }
        drawTaxi(spaceship.grid_loc.x,spaceship.grid_loc.y,"normal");
        drawPassenger(passenger.grid_loc.x,passenger.grid_loc.y,"normal");
}

    function record_data(){
        var end_time = performance.now();

        // record whether the user got the optimal trajectory or not
        same_traj = false;
        for (var j = 0; j < mdp_parameters.all_opt_actions.length; j++) {
            opt_moves = mdp_parameters.all_opt_actions[j]
            if (moves.length == opt_moves.length) {
                for (var k = 0; k < moves.length; k++) {
                    if (moves[k] != opt_moves[k]) {
                        // if one move differs, no need to consider other moves. they're not the same trajectory
                        break;
                    }
                }

                // if you've found a matching trajectory, no need to check other trajectories
                if (k == moves.length) {
                    same_traj = true;
                    break;
                }
            }
        }

        //console.log('augmented_taxi2_' + mdp_parameters.test_difficulty + '_' + mdp_parameters.tag.toString());
        //console.log(same_traj);

        var it = window.interaction_type
        if(it == "final test") {
            sessionStorage.setItem('augmented_taxi2_' + localStorage.getItem("iteration").toString(), same_traj)
        }

        final_data = JSON.stringify({
            'simulation_rt': (end_time - window.start_time),
            'moves': window.moves,
            'opt_response': same_traj,
            'agent_history_nonoffset': window.agent_history_nonoffset,
            'mdp_parameters': mdp_parameters,
        });

        var event = new CustomEvent("game-completed", { "detail": "Demonstration has now ended." });
        enableScroll();
        document.dispatchEvent(event);

        localStorage.setItem("user input", final_data);

        data_sent = true

        return same_traj
    }

      function draw()
      {
          if (!map_layout.set){
            set_grids();
            map_layout.set = true;
          }
          // Clear entire screen
          context.clearRect(0, 0, canvas.width, canvas.height);
          context.beginPath();
          context.fillStyle = "black";
          context.fill();
          context.closePath();

          //draw grid
          for (i = 0; i <= mdp_parameters.height; i++) {
                context.beginPath();
                context.moveTo(0+offset_x*100, 100*i-1+offset_y*100);
                context.lineTo(0+offset_x*100, 100*i+1+offset_y*100);
                context.lineTo(mdp_parameters.width*100+offset_x*100, 100*i+1+offset_y*100);
                context.lineTo(mdp_parameters.width*100+offset_x*100, 100*i-1+offset_y*100);
                context.fillStyle = "black";
                context.fill();
                context.closePath();
          }
          for (i = 0; i <= mdp_parameters.width; i++) {
                context.beginPath();
                context.moveTo(100*i-1+offset_x*100, 0+offset_y*100);
                context.lineTo(100*i+1+offset_x*100, 0+offset_y*100);
                context.lineTo(100*i+1+offset_x*100, mdp_parameters.height*100+offset_y*100);
                context.lineTo(100*i-1+offset_x*100, mdp_parameters.height*100+offset_y*100);
                context.fillStyle = "black";
                context.fill();
                context.closePath();
          }

          // indicate to the participant that it's their turn play
          if ((window.interaction_type.includes("test")) && (localStorage.getItem("already completed") == 'false')) {
            context.font = "25px Arial";
            context.fillStyle = text_color;
            context.textAlign = "center";
            context.fillText("Your turn to play!", offset_x * 100 + 200, 80);

            // Draw blue border around the grid
            context.beginPath();
            context.rect(offset_x*100 - 3, offset_y*100 - 3, mdp_parameters.width*100 + 6, mdp_parameters.height*100 + 6);
            context.strokeStyle = "blue";
            context.lineWidth = 2;
            context.stroke();
        }

        context.beginPath();
        // Begin drawing
        drawMap();
        //Single destination irrespective of version
        drawDestination();
        if (mdp_parameters.tag  == -2){
            drawTaxi(spaceship.grid_loc.human_x,spaceship.grid_loc.human_y,"light");
            drawPassenger(passenger.grid_loc.human_x,passenger.grid_loc.human_y,"light");
            drawHotswapStation(hotswap_station.grid_loc.human_x,hotswap_station.grid_loc.human_y,"human");
        }
        drawHotswapStation(hotswap_station.grid_loc.x,hotswap_station.grid_loc.y,"agent");
        if (mdp_parameters.tag  == -1){
            //Not needed unless single agents
            drawAgentHistory();
        }
        drawTaxi(spaceship.grid_loc.x,spaceship.grid_loc.y,"normal");
        drawPassenger(passenger.grid_loc.x,passenger.grid_loc.y,"normal");

          game_completed = false
          if (mdp_parameters.tag == -2) {
              if (passenger.dropped && passenger.dropped_human) game_completed = true;
          } else if (passenger.dropped) game_completed = true;

        if(game_completed)
        {
            context.font = "bold 28px Arial";
            context.fillStyle = text_color;
            context.textAlign = "center";
            context.fillText("Game completed!", (mdp_parameters.width*100)/2+offset_x*100, (mdp_parameters.height*100)/2+offset_y*100+200);

            //requestAnimationFrame(draw);

            if (data_sent == false) {
                var it = window.interaction_type;
                var last_test = localStorage.getItem("last test");

                same_traj = record_data()

                var show_likert = false

                if (it == "remedial test" || it == "diagnostic test") {
                    if (same_traj && localStorage.getItem("already completed") === "false") {
                        // if the test was answered correctly or page wasn't already shown previously, show likert scale
                        show_likert = true

                        if (localStorage.getItem("already completed") == 'false') $("#feedback").html('<div class="text-center"><h4>Great, you answered correctly!</h4><br></div>')
                    }
                    else {
                        // if the test was answered incorrectly or page was already shown previously, simply enable the next button
                        // set the likert value to 0 (changing from -1) so that you know that you've been to this page before
                        localStorage.setItem("survey", 0)
                        const subiteration = localStorage.getItem("subiteration")
                        if (localStorage.getItem("already completed") == 'false') {
                            $("#feedback").html('<div class="text-center"><h4>Oh no, you answered incorrectly! Let\'s review on the next page!</h4><br></div>')
                        }

                        $("#next").replaceWith(`<button type="button" id="next"
                        onclick="next()"
                        value="next" class="btn btn-primary btn-lg continue">
                        Next <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>` );
                    }
                } else if (it == "final test"){
                    if(last_test == "true"){
                        var score = 0;
                        var first = 0;
                        var second = 0;
                        var third = 0;
                        var fourth = 0;
                        var fifth = 0;
                        var sixth = 0;
                        if (sessionStorage.getItem('augmented_taxi2_0') == 'true') {
                            score += 1;
                            first += 1;
                        }
                        if (sessionStorage.getItem('augmented_taxi2_1') == 'true') {
                            score += 1;
                            second += 1;
                        }
                        if (sessionStorage.getItem('augmented_taxi2_2') == 'true') {
                            score += 1;
                            third += 1;
                        }
                        if (sessionStorage.getItem('augmented_taxi2_3') == 'true') {
                            score += 1;
                            fourth += 1;
                        }
                        if (sessionStorage.getItem('augmented_taxi2_4') == 'true') {
                            score += 1;
                            fifth += 1;
                        }
                        if (sessionStorage.getItem('augmented_taxi2_5') == 'true') {
                            score += 1;
                            sixth += 1;
                        }
                        console.log("game score: ")
                        console.log(score)
                        $("#feedback").html('<div class="text-center"><h1>Score Results</h1><p>In order of the tests you took, you scored <p id="score_val"></p>getting <p id="score_val2" style="display:inline"></p> tests correctly out of 6.</p></div>')
                        document.getElementById('score_val').innerHTML = first + ' + ' + second + ' + ' + third  + ' + ' + fourth  + ' + ' + fifth + ' + ' + sixth + ' = ' + score
                        document.getElementById('score_val2').innerHTML = score

                        // exploratory data collection on whether people are able to explicitly predict the weights
                        // for cl, pl, open,
                        $("#survey").html("<br><h3>Finally, please provide your best guess of energy change of the actions below (the last one is given and decimals are allowed!):</h3><table class='center'><tr><th>Actions</th><th>Sample sequence(s)</th><th>Energy change</th></tr><tr><td>Moving <u>out of</u> a yellow square (into yellow <u>or</u> white square)</td><td><img src = 'static/img/augmented_taxi2_toll1.png' width=auto height='125' /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/augmented_taxi2_toll2.png' width=auto height='125' /></td><td><input id='reward_ft_wt_1' type='number' style='width: 4em;'</>%</td></tr><tr><td>Moving through the green hexagon</td><td><img src = 'static/img/augmented_taxi2_battery1.png' width='75' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/augmented_taxi2_battery2.png' width='75' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/augmented_taxi2_battery3.png' width='75' height=auto /></td><td><input id='reward_ft_wt_2' type='number' style='width: 4em;'</>%</td></tr><tr><td>Any action that you take (e.g. moving right, picking up, etc)</td><td><img src = 'static/img/right1.png' width='150' height=auto /><img src = 'static/img/arrow.png' width='30' height=auto /><img src = 'static/img/right2.png' width='150' height=auto /></td><td>-1.0%</td></tr></table>")
                    }
                    $("#next").replaceWith(`<button type="button" id="next"
                    onclick="next()"
                    value="next" class="btn btn-primary btn-lg continue">
                    Next <span class="glyphicon glyphicon-arrow-right"></span>
                    </button>`);

                } else if (localStorage.getItem("already completed") === "false") {
                    show_likert = true
                }

                if (show_likert){
                    $("#survey").html(`<h3>Did this interaction improve your understanding of the game strategy?</h3>
                <div class="likert">
                <label><input name="info" type="radio" value="1"/><span>Not at all</span></label>
                <label><input name="info" type="radio" value="2"/><span>Slightly</span></label>
                <label><input name="info" type="radio" value="3"/><span>Moderately</span></label>
                <label><input name="info" type="radio" value="4"/><span>Very</span></label>
                <label><input name="info" type="radio" value="5"/><span>Extremely</span></label>
                </div>
                <br></br>

<h5>Please feel free to explain your selection if you wish!</h5>
            <textarea id="improvement short answer" rows="2" cols="50"></textarea>
` );
    var textarea = document.querySelector('textarea');
    textarea.addEventListener('keydown', function(event) {
        event.stopPropagation();
    });
                }
            }
        }
      }

      function left(version) {
        agent_on_hotswap_station = checkHotswap("agent");
        human_on_hotswap_station = checkHotswap("human");

        if (version == "agent"){
            if (spaceship.grid_loc.x > offset_x && map_layout.color_blocks[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x-1-offset_x] != 1){
            spaceship.grid_loc.x -= 1;
            window.moves.push("left");
            // agent_history_nonoffset needs to be updated within movement functions to ignore stray key presses that don't change the state
            window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
            if (passenger.picked){
                passenger.grid_loc.x -= 1;
            }
            if (agent_on_hotswap_station) {
                hotswap_station.visited = true;
            }
        }
        }
        else{
            if (spaceship.grid_loc.human_x > offset_x && map_layout.color_blocks[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x-1-offset_x] != 1){
            spaceship.grid_loc.human_x -= 1;
            if (passenger.picked_human){
                passenger.grid_loc.human_x -= 1;
            }
            if (human_on_hotswap_station) {
                hotswap_station.visited_human = true;
            }
            }
            }
      }

      function right(version) {
        agent_on_hotswap_station = checkHotswap("agent");
        human_on_hotswap_station = checkHotswap("human");

        if (version == "agent"){
            if (spaceship.grid_loc.x < mdp_parameters.width-1+offset_x && map_layout.color_blocks[spaceship.grid_loc.y-offset_y][spaceship.grid_loc.x+1-offset_x] != 1){
            spaceship.grid_loc.x += 1;
            window.moves.push("right");
            window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
            if (passenger.picked){
                passenger.grid_loc.x += 1;
            }
            if (agent_on_hotswap_station) {
                hotswap_station.visited = true;
            }
        }
        }
        else{
            if (spaceship.grid_loc.human_x < mdp_parameters.width-1+offset_x && map_layout.color_blocks[spaceship.grid_loc.human_y-offset_y][spaceship.grid_loc.human_x+1-offset_x] != 1){
            spaceship.grid_loc.human_x += 1;
            if (passenger.picked_human){
                passenger.grid_loc.human_x += 1;
            }
            if (human_on_hotswap_station) {
                hotswap_station.visited_human = true;
            }
            }
            }
      }

      function up(version) {
        agent_on_hotswap_station = checkHotswap("agent");
        human_on_hotswap_station = checkHotswap("human");

        if (version == "agent"){
            if (spaceship.grid_loc.y > offset_y && map_layout.color_blocks[spaceship.grid_loc.y-1-offset_y][spaceship.grid_loc.x-offset_x] != 1){
            spaceship.grid_loc.y -= 1;
            window.moves.push("up");
            window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
            if (passenger.picked){
                passenger.grid_loc.y -= 1;
            }
            if (agent_on_hotswap_station) {
                hotswap_station.visited = true;
            }
        }
        }
        else{
            if (spaceship.grid_loc.human_y > offset_y && map_layout.color_blocks[spaceship.grid_loc.human_y-1-offset_y][spaceship.grid_loc.human_x-offset_x] != 1){
            spaceship.grid_loc.human_y -= 1;
            if (passenger.picked_human){
                passenger.grid_loc.human_y -= 1;
            }
            if (human_on_hotswap_station) {
                hotswap_station.visited_human = true;
            }
            }
            }

      }

      function down(version) {
        agent_on_hotswap_station = checkHotswap("agent");
        human_on_hotswap_station = checkHotswap("human");

        if (version == "agent"){
            if (spaceship.grid_loc.y < mdp_parameters.height-1+offset_y && map_layout.color_blocks[spaceship.grid_loc.y+1-offset_y][spaceship.grid_loc.x-offset_x] != 1){
            spaceship.grid_loc.y += 1;
            window.moves.push("down");
            window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
            if (passenger.picked){
                passenger.grid_loc.y += 1;
            }
            if (agent_on_hotswap_station) {
                hotswap_station.visited = true;
            }
        }
        }
        else{
            if (spaceship.grid_loc.human_y < mdp_parameters.height-1+offset_y && map_layout.color_blocks[spaceship.grid_loc.human_y+1-offset_y][spaceship.grid_loc.human_x-offset_x] != 1){
            spaceship.grid_loc.human_y += 1;
            if (passenger.picked_human){
                passenger.grid_loc.human_y += 1;
            }
            if (human_on_hotswap_station) {
                hotswap_station.visited_human = true;
            }
            }
            }
      }

      function pickup(version) {
        if (version == "agent"){
            if (Math.floor(spaceship.grid_loc.x) == Math.floor(passenger.grid_loc.x) && spaceship.grid_loc.y == passenger.grid_loc.y && passenger.picked == false){
                moves.push("pickup");
                window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
                passenger.picked = true;
        }}
        else{
            console.log("here")
            if (Math.floor(spaceship.grid_loc.human_x) == Math.floor(passenger.grid_loc.human_x) && spaceship.grid_loc.human_y == passenger.grid_loc.human_y && passenger.picked_human == false){
                passenger.picked_human = true;
        }}
      }

      function no_op(){
        return;
      }

      function dropoff(version) {
        if (version == "agent"){
            condition_goal = ((Math.floor(spaceship.grid_loc.x) == goal.grid_loc.x) && (spaceship.grid_loc.y == goal.grid_loc.y));

            if (passenger.picked){
                window.moves.push("dropoff");
                passenger.picked = false;
                if (condition_goal){
                    passenger.dropped = true;
                    //watched_vid_arr[current_page] = true;
                    console.log(moves);
                    window.agent_history_nonoffset.push([spaceship.grid_loc.x + 1 - offset_x, mdp_parameters.height - spaceship.grid_loc.y + offset_y, passenger.picked])
                }
            }
        }
        else{
            condition_goal = ((Math.floor(spaceship.grid_loc.human_x) == goal.grid_loc.x) && (spaceship.grid_loc.human_y == goal.grid_loc.y));

            if (passenger.picked_human){
                passenger.picked_human = false;
                if (condition_goal){
                    passenger.dropped_human = true;
                }
            }
        }


      }

      function reset() {
        moves = [];
        map_layout.set = false;
        passenger.picked = false;
        passenger.picked_human = false;
        hotswap_station.visited = false;
        hotswap_station.visited_human = false;
        window.agent_history = [];
        window.agent_history_nonoffset = [];
      }

      function checkHotswap(version){
        if (version == "agent"){
            if (spaceship.grid_loc.x == hotswap_station.grid_loc.x && spaceship.grid_loc.y == hotswap_station.grid_loc.y) {
                return true;
            }
            else {
                return false;
            }
        }
        else{
            if (spaceship.grid_loc.human_x == hotswap_station.grid_loc.human_x && spaceship.grid_loc.human_y == hotswap_station.grid_loc.human_y) {
                return true;
            }
            else {
                return false;
            }
        }
    }

    function disableScroll() {
            scrollTop = window.pageYOffset

            window.onscroll = function() {
                window.scrollTo(scrollTop);
            };
        }

        function enableScroll() {
            window.onscroll = function() {};
        }

      var idx = 0;
      var agent_human_spacer = -0.2;
      if (mdp_parameters.tag == -2) {
          var translate_draw = 10;
      }
      else {
          var translate_draw = 0;
      }

      function keyPressed(event)
      {
        if (mdp_parameters.tag == -2) {
            //training case, agent & human

                if (event.keyCode == 32) {
                    //space bar pressed, advance demo

                    var next_action_agent = mdp_parameters.normalized_opt_actions[idx];
                    var next_action_human = mdp_parameters.normalized_human_actions[idx];
                    console.log("agent:" + next_action_agent);
                    console.log("human:" + next_action_human);
                    idx++;
                    switch (next_action_human) {
                        case "left":
                            left("human");
                            break;
                        case "right":
                            right("human");
                            break;
                        case "up":
                            up("human");
                            break;
                        case "down":
                            down("human");
                            break;
                        case "pickup":
                            pickup("human");
                            break;
                        case "dropoff":
                            dropoff("human");
                            break;
                        case "no-op":
                            no_op();
                            break;
                    }
                    switch (next_action_agent) {
                        case "left":
                            left("agent");
                            break;
                        case "right":
                            right("agent");
                            break;
                        case "up":
                            up("agent");
                            break;
                        case "down":
                            down("agent");
                            break;
                        case "pickup":
                            pickup("agent");
                            break;
                        case "dropoff":
                            dropoff("agent");
                            break;
                        case "no-op":
                            no_op();
                            break;
                    }
                    //agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y]);
                    requestAnimationFrame(draw);
                }
             if (event.keyCode == 82) {
                    idx = 0;
                    reset();
                    requestAnimationFrame(draw);
                }
        }
        else if (mdp_parameters.tag == -1) {
                    //training case, just agent
                    if (event.keyCode == 32) {
                        //space bar pressed, advance demo
                        var next_action_agent = mdp_parameters.opt_actions[idx];
                        console.log(next_action_agent);
                        idx++;
                        switch (next_action_agent) {
                            case "left":
                                left("agent");
                                break;
                            case "right":
                                right("agent");
                                break;
                            case "up":
                                up("agent");
                                break;
                            case "down":
                                down("agent");
                                break;
                            case "pickup":
                                pickup("agent");
                                break;
                            case "dropoff":
                                dropoff("agent");
                                break;
                        }
                        window.agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y]);
                        requestAnimationFrame(draw);
                    } else if (event.keyCode == 82) {
                        idx = 0;
                        reset();
                        requestAnimationFrame(draw);
                    }
            }
        else {
            //testing case
            // prevent arrow keys from simultaneously moving the window
            if([37, 38, 39, 40].indexOf(event.keyCode) > -1) {
                event.preventDefault();
            }
            if (!passenger.dropped) {
                switch (event.keyCode) {
                    case 37:
                        // Left Arrow key
                        left("agent");
                        break;
                    case 39:
                        // Right Arrow key
                        right("agent");
                        break;
                    case 38:
                        // Up Arrow key
                        up("agent");
                        break;
                    case 40:
                        // down Arrow key
                        down("agent");
                        break;
                    case 71:
                        //g key
                        pickup("agent");
                        break;
                    case 68:
                        //d key
                        dropoff("agent");
                        break;
                    case 82:
                        //r key
                        reset("agent");
                        break;
                }
                if (event.keyCode != 82) {
                    window.agent_history.push([spaceship.grid_loc.x, spaceship.grid_loc.y]);
                }
                requestAnimationFrame(draw);
            }
        }
      }

        function filterMovementKeys(event) {
            // This function will run every time a key is pressed...
            if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].indexOf(event.code) > -1) {
                event.preventDefault();
            }
        }

        // Debounce the keyPressed function
        var debouncedKeyPressed = _.debounce(keyPressed, 100); // limit consecutive keystrokes
      //var debouncedKeyPressed = keyPressed;

        // Create a new function that calls both functions
        function keydownHandler(event) {
            filterMovementKeys(event);
            debouncedKeyPressed(event);
        }
        document.addEventListener('keydown', keydownHandler);
    start_screen();
    canvas.addEventListener('click', draw);
    context.restore();
    return "finished execution";
  }
    </script>
  </body>
</html>